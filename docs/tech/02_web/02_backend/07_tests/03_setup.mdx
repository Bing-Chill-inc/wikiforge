# Point d'entr√©e

## Description G√©n√©rale

Le fichier `setup.test.ts` est responsable de l'initialisation de l'environnement de test pour l'application backend d'AlgoForge. Il configure les pr√©requis n√©cessaires avant l'ex√©cution des tests unitaires et d'int√©gration, notamment la r√©initialisation de la base de donn√©es et le lancement des suites de tests. Ce fichier garantit que chaque test d√©marre dans un environnement propre et coh√©rent.

---

## Objectifs des Tests

### 1. **Initialisation de l'Environnement**

-   V√©rifier que l'application est en mode `test` avant de lancer les tests.
-   S'assurer que l'application est correctement initialis√©e avant de d√©marrer les tests.

### 2. **R√©initialisation de la Base de Donn√©es**

-   Supprimer toutes les donn√©es existantes dans les tables de la base de donn√©es.
-   Garantir un environnement propre pour chaque ex√©cution des tests.

### 3. **Ex√©cution des Suites de Tests**

-   Lancer les tests unitaires et d'int√©gration pour les diff√©rentes fonctionnalit√©s de l'application (par exemple, utilisateurs, algorithmes).

---

## Fonctionnalit√©s Principales

### 1. **V√©rification du Mode de l'Application**

Le fichier v√©rifie que l'application est en mode `test` avant de d√©marrer les tests. Si ce n'est pas le cas, un message d'erreur est affich√© et le processus est arr√™t√©.

#### Exemple :

```typescript
if (process.env.BUILD !== "test") {
	Logger.error("Le mode de l'application doit √™tre 'test'.", "test: setup");
	Logger.warn("ATTENTION: ceci supprime toutes les donn√©es de la base de donn√©es.", "test: setup");
	process.exit(1);
}
```

---

### 2. **Initialisation Avant les Tests**

Le hook `beforeAll` attend que l'application soit compl√®tement initialis√©e avant de lancer les tests. Une fois l'application pr√™te, il r√©initialise la base de donn√©es en supprimant toutes les donn√©es existantes.

#### Exemple :

```typescript
beforeAll(async (done) => {
	Logger.log("Waiting for application to be initialized...", "test: setup");
	const interval = setInterval(async () => {
		if (app.locals.initialized && !app.locals.testSetupInit) {
			Logger.log("Application initialized !", "test: setup");
			app.locals.testSetupInit = true;
			clearInterval(interval);
			await clearAllTables();
			app.locals.testSetupDone = true;
			done();
		}
	}, 1000);
});
```

---

### 3. **R√©initialisation de la Base de Donn√©es**

La fonction `clearAllTables` supprime toutes les donn√©es des tables de la base de donn√©es. Elle utilise les entit√©s d√©finies dans le projet pour identifier les tables √† nettoyer.

#### Exemple :

```typescript
async function clearAllTables() {
	Logger.log("Cleaning database...", "test: setup");
	const entities = [PermAlgorithme, PermDossier, Dossier, Algorithme, Token, Utilisateur];

	for (const entity of entities) {
		const repository = AppDataSource.getRepository(entity.name);
		Logger.debug(`Clearing table: ‚è≥ ${repository.metadata.tableName}`, "test: setup", 5);
		await AppDataSource.query(`DELETE FROM ${repository.metadata.tableName}`);
		Logger.debug(`Clearing table: üßπ ${repository.metadata.tableName} `, "test: setup", 5);
	}

	Logger.log("Cleaning done !", "test: setup");
}
```

---

### 4. **Ex√©cution des Suites de Tests**

Le hook `afterAll` ex√©cute les suites de tests d√©finies dans les fichiers `algos.test.ts` et `users.test.ts` apr√®s l'initialisation.

#### Exemple :

```typescript
afterAll(async (done) => {
	await UsersTests();
	await AlgosTests();
	done;
});
```

---

## Points Techniques

### 1. **Utilisation des Hooks `beforeAll` et `afterAll`**

-   **`beforeAll`** : Pr√©pare l'environnement de test avant l'ex√©cution des tests (par exemple, nettoyage de la base de donn√©es).
-   **`afterAll`** : Lance les suites de tests apr√®s l'initialisation.

### 2. **R√©initialisation Compl√®te de la Base de Donn√©es**

-   Toutes les tables de la base de donn√©es sont vid√©es avant chaque ex√©cution des tests.
-   Cela garantit que les tests ne sont pas influenc√©s par des donn√©es r√©siduelles.

### 3. **V√©rification de l'√âtat de l'Application**

-   Le fichier utilise un intervalle pour v√©rifier si l'application est compl√®tement initialis√©e avant de commencer les tests.

### 4. **Gestion des Logs**

-   Les √©tapes importantes (par exemple, nettoyage de la base de donn√©es, initialisation de l'application) sont enregistr√©es dans les logs pour faciliter le suivi et le d√©bogage.

---

## Exemple de Flux

1. **V√©rification du Mode `test`** :

    - Le fichier v√©rifie que l'application est en mode `test`. Si ce n'est pas le cas, le processus est arr√™t√©.

2. **Initialisation de l'Application** :

    - Le hook `beforeAll` attend que l'application soit compl√®tement initialis√©e.

3. **Nettoyage de la Base de Donn√©es** :

    - Toutes les tables de la base de donn√©es sont vid√©es pour garantir un environnement propre.

4. **Ex√©cution des Tests** :
    - Les suites de tests (`UsersTests`, `AlgosTests`) sont ex√©cut√©es.
